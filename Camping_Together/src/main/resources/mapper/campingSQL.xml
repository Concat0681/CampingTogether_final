<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="camping">
	<select id="selectCampingListData" parameterType="map" resultType="c">
		select * from
			(select 
				rownum as rnum, 
				c.*,
				(select avg(camping_review_rating) from camping_review join camping using(camping_no) where camping_no = c.campingNo ) as avgReviewRating,
				(select max(camping_room_price) from camping_room join camping using(camping_no) where camping_no = c.campingNo) as maxRoomPrice
			from
				(select 
					camping_no as campingNo,
					member_id as memberId,
					camping_title as campingTitle,
					camping_content as campingContent,
					camping_addr as campingAddr,
					camping_addr_detail as campingAddrDetail,
					camping_phone as campingPhone,
					filepath
				from camping 
             )c
			<trim prefix="where" prefixOverrides="and|or">
				<if test="campingRoomTypeList != null">
					 campingNo in (select camping_no from camping_room where camping_room_type in
					<foreach collection="campingRoomTypeList" item="type" open="(" close=")" separator=",">
						 #{type}
					</foreach>
					)
				</if>
				<if test="campingEtcList != null">
					and campingNo in (select camping_no from camping_etc where camping_etc in
					<foreach collection="campingEtcList" item="etc" open="(" close=")" separator=",">
						 #{etc.campingEtc}
					</foreach>
					)
				</if>
				<if test="campingRoomServiceList != null">
					and campingNo in (select camping_no from camping_room_service where camping_room_service in
					<foreach collection="campingRoomServiceList" item="rs" open="(" close=")" separator=",">
						 #{rs.campingRoomService}
					</foreach>
					)
				</if>
				<if test="campingProvideServiceList != null">
					and campingNo in (select camping_no from camping_service where camping_service in
					<foreach collection="campingProvideServiceList" item="cps" open="(" close=")" separator=",">
						 #{cps.campingService}
					</foreach>
					)
				</if>
				<if test="pplCount != 0">
					and campingNo in (select camping_no from camping_room_service where camping_room_max_ppl_count <![CDATA[ >= ]]> #{pplCount}
				</if>
			</trim>
		<choose>
			<when test="order.equals('avgReviewRating')">
				order by avgReviewRating desc)
			</when>
			<when test="order.equals('maxRoomPrice')">
				order by maxRoomPrice desc)
			</when>
		</choose>
	where rnum between #{start} and #{end}
	</select>
	
	<select id="selectCampingCount" resultType="_int">
		select count(*) from camping
	</select>
	
	<select id="selectOneCamping" parameterType="_int" resultType="c">
		select 
			camping_no as campingNo,
			member_id as memberId,
			camping_title as campingTitle,
			camping_content as campingContent,
			camping_addr as campingAddr,
			camping_addr_detail as campingAddrDetail,
			camping_phone as campingPhone,
			camping_service as campingProvideServiceList,
			camping_room_service as campingRoomServiceList,
			camping_etc as campingEtcList,
			filepath
		from camping 
		left join camping_service using(camping_no)
		left join camping_room_service using(camping_no)
		left join camping_etc using(camping_no)
		where camping_no = #{_parameter}
	</select>
	
	<select id="selectAllCampingRoomList" parameterType="_int" resultType="cr">
		select 
			camping_room_no as campingRoomNo,
			camping_room_title as campingRoomTitle,
 			camping_room_content campingRoomContent,
			camping_room_price as campingRoomPrice,
			camping_room_count as campingRoomCount,
			camping_room_max_ppl_count as campingRoomMaxPplCount,
			camping_room_type as campingRoomType
		from camping_room where camping_no = #{_parameter}
	</select>
	
	<insert id="insertCamping" parameterType="c">
		insert into camping values(camping_seq.nextval,'user01',#{campingTitle},#{campingContent},#{campingAddr},#{campingAddrDetail},#{campingPhone},#{filepath})
		<selectKey resultType="_int" order="AFTER" keyProperty="campingNo">
			select max(camping_no) from camping
		</selectKey>
	</insert>
	
	
	<insert id="insertCampingRoom" parameterType="cr">
		insert into camping_room values(camping_room_seq.nextval,'2',#{campingRoomContent},#{campingRoomPrice},#{campingRoomCount},#{campingRoomMaxPplCount},#{roomTitle},#{campingRoomType[0]})
		<selectKey resultType="_int" order="AFTER" keyProperty="campingRoomNo">
			select max(camping_room_no) from camping_room
		</selectKey>
	</insert>
	
	<insert id="insertCampingRoomPhoto" parameterType="crf">
		insert into camping_room_photo values(camping_room_photo_seq.nextval,'23',#{filepath})
	</insert>
	
	<insert id="insertCampingProvideService" parameterType="cps">
		insert into camping_service values(camping_service_seq.nextval,#{campingNo},#{campingService})
	</insert>
	
	<insert id="insertCampingRoomService" parameterType="crs">
		insert into camping_room_service values(camping_room_service_seq.nextval,#{campingNo},#{campingRoomService})
	</insert>
	
	<insert id="insertCampingEtc" parameterType="ce">
		insert into camping_etc values(camping_etc_seq.nextval,#{campingNo},#{campingEtc})
	</insert>
</mapper>
